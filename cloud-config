#cloud-config
 
hostname: chihiro
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAyukAK+pD6B3EkOlGtTC5Oyqx9N/1AZYqkaP0QEVn6pr+vkXlhE7CljfTT1egRGp76Ud18H3tCLDy6rhTpH5Kb+96eC8AWeKNrFbQWEjaBPbPlMUa96AeY+HXqH8JlHPkPu8k0BRVpnfeC6WKth8qU7j5CyqIH+SArKX5RvNgbqsxnR0X0XuvBKCiWt90yqnEC7JvCuznCKPeeLUOOjtf/9kYBfDIZdBKvIYxTZ7nx1WXQMeVxmsQrM29BPtZSXGhNQhDPHzIxDV8bNrXy5HXpCIQS3Qsv+T1TMgYjAl+C/1T+CW5wC+rLJTpdOjlRJThBYJw1xgQsfUIPedh3kEEpQ==
  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ==
users:
  - name: eatnumber1
    groups:
      - sudo
      - docker
    coreos-ssh-import-github: eatnumber1
coreos:
  update:
    reboot-strategy: off
  etcd:
    name: chihiro
    #discovery: https://discovery.etcd.io/5ec6be07000f9add06e321b0b5911f90
    #peers: 192.168.1.2:7001
    addr: 192.168.1.2:4001
    peer-addr: 192.168.1.2:7001
  fleet:
    public-ip: 192.168.1.2
  flannel:
    etcd-prefix: /flannel.eatnumber1.com/network
    interface: 192.168.1.2
  units:
    - name: settimezone.service
      command: start
      content: |
        [Unit]
        Description=Set the timezone

        [Service]
        ExecStart=/usr/bin/timedatectl set-timezone America/Los_Angeles
        RemainAfterExit=yes
        Type=oneshot
    - name: custom-reboot.service
      runtime: true
      content: |
        [Unit]
        Description=Reboot if needed

        [Service]
        ExecStart=/usr/bin/bash -c 'if update_engine_client -status | grep NEED_REBOOT; then reboot; fi' 
    - name: custom-reboot.timer
      runtime: true
      command: start
      content: |
        [Unit]
        Description=Reboot if needed at 05:00 daily

        [Timer]
        OnCalendar=*-*-* 05:00:00
    - name: var-lib-docker.mount
      command: start
      content: |
        [Unit]
        Description=Mount docker subvol to /var/lib/docker
        Before=docker.service

        [Mount]
        What=/dev/disk/by-label/space
        Where=/var/lib/docker
        Type=btrfs
        Options=subvol=docker
    - name: space.mount
      command: start
      content: |
        [Unit]
        Description=Mount space to /space

        [Mount]
        What=/dev/disk/by-label/space
        Where=/space
        Type=btrfs
    - name: flanneld.service
      drop-ins:
        - name: 50-network-config.conf
          content: |
            [Service]
            ExecStartPre=/usr/bin/etcdctl set /flannel.eatnumber1.com/network/config '{"Network":"172.29.112.0/24"}'
      command: start
    - name: setup-network-environment.service
      runtime: true
      command: start
      content: |
        [Unit]
        Description=Setup Network Environment
        Documentation=https://github.com/kelseyhightower/setup-network-environment
        Requires=network-online.target
        After=network-online.target
        Requires=docker.service
        After=docker.service
        Requires=flanneld.service
        After=flanneld.service

        [Service]
        # Sleep to wait for docker0 to come up
        ExecStartPre=-/usr/bin/sleep 3
        ExecStartPre=-/usr/bin/mkdir -p /opt/bin
        ExecStartPre=/usr/bin/curl -L -o /opt/bin/setup-network-environment https://github.com/kelseyhightower/setup-network-environment/releases/download/v1.0.0/setup-network-environment

        ExecStartPre=/usr/bin/chmod +x /opt/bin/setup-network-environment
        ExecStart=/opt/bin/setup-network-environment
        RemainAfterExit=yes
        Type=oneshot
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start
      drop-ins:
        - name: 01-deps.conf
          content: |
            [Unit]
            Requires=setup-network-environment.service
            After=setup-network-environment.service
            Requires=flanneld.service
            After=flanneld.service

# vim:et ts=2 sw=2 sts=2 ai
